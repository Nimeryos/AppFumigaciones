<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Edificios</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    #grid {
      display: grid;
      gap: 4px;
      max-width: 100%;
      margin-bottom: 20px;
    }

    .cell {
      width: 50px;
      aspect-ratio: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .stats {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 250px;
    }

    @media (max-width: 600px) {
      .cell { width: 35px; }
    }
  </style>
</head>
<body>

  <div class="controls">
    <input id="buildingName" placeholder="Nombre del edificio" />
    <input id="rows" type="number" placeholder="Filas" min="1" />
    <input id="cols" type="number" placeholder="Columnas" min="1" />
    <button id="newBuilding">Nuevo edificio</button>
    <button id="saveBuilding">Guardar</button>
    <button id="clearGrid">Borrar grilla</button>
    <button id="exportCSV">Exportar CSV</button>
    <select id="savedBuildings"></select>
  </div>

  <div id="grid"></div>

  <div class="stats">
    <h4>Estadísticas</h4>
    <p id="countX">X: 0</p>
    <p id="countDash">-: 0</p>
    <p id="countNO">NO: 0</p>
    <p id="countXG">XG: 0</p>
  </div>

<script>
  const grid = document.getElementById("grid");
  const rowsInput = document.getElementById("rows");
  const colsInput = document.getElementById("cols");
  const nameInput = document.getElementById("buildingName");
  const savedSelect = document.getElementById("savedBuildings");

  const OPTIONS = ["", "X", "-", "NO", "XG"];
  const COLORS = {
    "X": "#4a90e2",
    "-": "#e26a6a",
    "NO": "#4caf50",
    "XG": "#76d7ea",
    "": "white"
  };

  function generateGrid() {
    const rows = parseInt(rowsInput.value) || 0;
    const cols = parseInt(colsInput.value) || 0;

    grid.style.gridTemplateColumns = `repeat(${cols}, minmax(35px, 1fr))`;
    grid.innerHTML = "";

    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const cell = document.createElement("div");
        cell.className = "cell";

        const select = document.createElement("select");
        OPTIONS.forEach(op => {
          const o = document.createElement("option");
          o.value = op;
          o.textContent = op;
          select.appendChild(o);
        });

        select.addEventListener("change", () => {
          cell.style.background = COLORS[select.value];
          updateStats();
        });

        cell.appendChild(select);
        grid.appendChild(cell);
      }
    }

    updateStats();
  }

  function updateStats() {
    let countX = 0, countDash = 0, countNO = 0, countXG = 0;

    document.querySelectorAll("#grid select").forEach(s => {
      if (s.value === "X") countX++;
      else if (s.value === "-") countDash++;
      else if (s.value === "NO") countNO++;
      else if (s.value === "XG") countXG++;
    });

    document.getElementById("countX").textContent = `X: ${countX}`;
    document.getElementById("countDash").textContent = `-: ${countDash}`;
    document.getElementById("countNO").textContent = `NO: ${countNO}`;
    document.getElementById("countXG").textContent = `XG: ${countXG}`;
  }

  function saveBuilding() {
    if (!nameInput.value) return alert("Poné un nombre al edificio");

    const rows = rowsInput.value;
    const cols = colsInput.value;
    const values = [...document.querySelectorAll("#grid select")].map(s => s.value);

    const data = { rows, cols, values };
    localStorage.setItem("edificio_" + nameInput.value, JSON.stringify(data));
    loadSavedBuildings();
  }

  function loadSavedBuildings() {
    savedSelect.innerHTML = "";
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith("edificio_")) {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k.replace("edificio_", "");
        savedSelect.appendChild(opt);
      }
    });
  }

  function loadBuilding(key) {
    const data = JSON.parse(localStorage.getItem(key));
    if (!data) return;

    nameInput.value = key.replace("edificio_", "");
    rowsInput.value = data.rows;
    colsInput.value = data.cols;

    generateGrid();

    const selects = document.querySelectorAll("#grid select");
    selects.forEach((s, i) => {
      s.value = data.values[i];
      s.parentElement.style.background = COLORS[s.value];
    });

    updateStats();
  }

  function exportCSV() {
    const name = nameInput.value || "edificio";

    let csv = "";
    const cols = parseInt(colsInput.value);

    const values = [...document.querySelectorAll("#grid select")].map(s => s.value);
    for (let i = 0; i < values.length; i += cols) {
      csv += values.slice(i, i + cols).join(",") + "
";
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = name + ".csv";
    a.click();

    URL.revokeObjectURL(url);
  }

  document.getElementById("newBuilding").onclick = generateGrid;
  document.getElementById("saveBuilding").onclick = saveBuilding;
  document.getElementById("clearGrid").onclick = () => generateGrid();
  document.getElementById("exportCSV").onclick = exportCSV;

  savedSelect.onchange = () => loadBuilding(savedSelect.value);

  loadSavedBuildings();
</script>
</body>
</html>
